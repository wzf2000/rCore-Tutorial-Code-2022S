## OS Lab2 实验报告

<h4>王哲凡 计93 2019011200</h4>

### 实现功能

- 对于 `sys_get_time` 和 `sys_task_info` 的重新实现，需要通过虚拟地址到物理地址的转换，通过 `translated_byte_buffer` 接口和类型转换即可实现。
- 对于 `sys_mmap` 和 `sys_munmap`，特别实现了 `current_memory_map/unmap` 等接口，其中包含虚拟地址区间的验证等实现，需要注意用户态权限的添加。

### 问答题

#### 第 1 题

页表项组成为：
- $63 \sim 54$ 位为 `Reserved` 即保留项。
- $53 \sim 28$ 位、$27 \sim 19$ 位、$18 \sim 10$ 位为 `PPN[2], PPN[1], PPN[0]` 即分为三级的物理页号。
- $9 \sim 8$ 位为 `RSW`，留给操作系统使用的保留位。
- $7 \sim 0$ 位分别为 `DAGUXWRV`，是页表项的标志位，其中具体含义如下：
    - `V` 表示页表项是否合法。
    - `R/W/X` 分别表示页表项对应的虚拟页面是否允许读/写/取指。
    - `U` 表示是否为 U 态页表，$1$ 表示 U 态页表，$0$ 表示 S 态页表。
    - `A` 记录自从页表项上对应位清零后，对应虚拟页面是否被访问过。
    - `D` 记录自从页表项上对应位清零后，对应虚拟页表是否被修改过。 

#### 第 2 题

##### 第 (1) 题

缺页导致异常可能有：
- 指令缺页异常。
- `LOAD` 缺页异常。
- `STORE/AMO` 缺页异常。

##### 第 (2) 题

重要寄存器包括：
- `scause`：`CSR` 寄存器`scause` 中会记录中断/异常发生时的信息，其中 `Interrupt` 位记录此次是中断还是异常，`Exception Code` 记录中断/异常的种类。
- `sstatus`：记录处理器当前状态，其中 `SPP` 段记录发生异常前的特权等级。
- `stvec`：记录处理中断/异常的入口地址，有两种模式 `Direct` 和 `Vectored`。
- `sscratch`：指向相关的 S 态上下文的指针，如内核栈指针。
- `sepc`：记录中断/异常发生时发生异常的指令地址，用于中断/异常处理完成后返回。
- `stval`：中断/异常发生进入 S 态时，记录了额外的异常信息，用于帮助处理中断/异常。

##### 第 (3) 题

Lazy 策略可以保证不比朴素的策略慢，且对于部分要求加载却未实际使用就被释放的页面，可以避免无效加载，以此提升效率。

##### 第 (4) 题

大致占用 $10\mathrm{GB} / 4096\mathrm{B} \times 8 \mathrm{B} = 20\mathrm{MB}$。

##### 第 (5) 题

将现有策略修改为，分配内存时不立即进行分配，仅仅记录相关的虚拟内存信息等。

在实际访问导致缺页时处理器会自动触发缺页异常，可以在 `trap handler` 中对于不同的 PageFault 异常，添加将页面数据从磁盘加载或分配到内存的逻辑。

##### 第 (6) 题

对于因为 swap 策略导致失效的页面，其页表项的标志位 `V` 会被置为 $0$。

#### 第 3 题

##### 第 (1) 题

只须在用户进程/程序时切换页表。

在 `__switch` 中，先保存当前的任务上下文，再通过页表根节点地址切换页表，最后加载新任务的上下文即可。

##### 第 (2) 题

将内核页面对应页表项的 `U` 标志位设置为 $0$。

##### 第 (3) 题

在 S 态（内核态）和 U 态（用户态）之间转换的时候，可以省去更换页表的流程，自然就不需要特别设置跳板页，可像之前的实验中那样直接切换上下文。

##### 第 (4) 题

- 双页表：用户程序/进程和内核切换、用户程序/进程切换时更换页表。
- 单页表：只须在不同用户进程/程序切换时才需要更换页表。

### 建议

`TaskStatus` 类中似乎误删了 `UnInit`，使得正常的实现难以通过测例。

默认的栈空间不足以包含所有的测例，需要手动修改 `MEMORY_END` 的值。
